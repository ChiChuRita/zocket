---
title: Creating Instance
description: Learn how to create and configure a Zocket server instance.
---

# Creating a Zocket Instance

The `zocket.create()` function initializes your Zocket server with configuration for headers, connection lifecycle, and user context.

## Basic Instance

```typescript
import { z } from "zod";
import { zocket } from "@zocket/core";

const zo = zocket.create({
  headers: z.object({}),
});
```

## With Header Validation

Validate client headers on connection:

```typescript
const zo = zocket.create({
  headers: z.object({
    authorization: z.string(),
    "user-agent": z.string().optional(),
  }),
});
```

Headers from the client must match this schema or the connection is rejected.

## With User Context

Create user context from headers:

```typescript
const zo = zocket.create({
  headers: z.object({
    token: z.string(),
  }),
  onConnect: async (headers, clientId) => {
    const user = await validateToken(headers.token);

    return {
      userId: user.id,
      username: user.name,
      role: user.role,
      isAuthenticated: true,
    };
  },
});
```

The returned object becomes part of `ctx` in all handlers.

## Connection Lifecycle

### onConnect

Called when a client connects:

```typescript
const zo = zocket.create({
  headers: z.object({ user: z.string() }),
  onConnect: async (headers, clientId) => {
    console.log(`✅ ${headers.user} connected (${clientId})`);

    await database.logConnection(clientId, headers.user);

    return {
      user: headers.user,
      connectedAt: Date.now(),
    };
  },
});
```

**Parameters:**

- `headers`: Validated headers object
- `clientId`: Unique client identifier

**Returns:** Object that becomes part of context

### onDisconnect

Called when a client disconnects:

```typescript
const zo = zocket.create({
  headers: z.object({ user: z.string() }),
  onConnect: (headers) => ({ user: headers.user }),
  onDisconnect: async (ctx, clientId) => {
    console.log(`❌ ${ctx.user} disconnected (${clientId})`);

    await database.logDisconnection(clientId);

    // Clean up user data
    await cleanupUserData(ctx.user);
  },
});
```

**Parameters:**

- `ctx`: User context (without send/rooms operations)
- `clientId`: Unique client identifier

## Configuration Options

```typescript
const zo = zocket.create({
  // Required: Header schema
  headers: z.object({
    authorization: z.string(),
  }),

  // Optional: Create user context
  onConnect: async (headers, clientId) => {
    return {
      /* user data */
    };
  },

  // Optional: Clean up on disconnect
  onDisconnect: async (ctx, clientId) => {
    // cleanup
  },
});
```

## Complete Example

```typescript
import { z } from "zod";
import { zocket } from "@zocket/core";

const zo = zocket.create({
  headers: z.object({
    token: z.string().min(1),
    "client-version": z.string().default("1.0.0"),
  }),

  onConnect: async (headers, clientId) => {
    try {
      const user = await validateToken(headers.token);

      console.log(`✅ ${user.name} connected`);
      console.log(`   Client ID: ${clientId}`);
      console.log(`   Version: ${headers["client-version"]}`);

      await database.users.updateLastSeen(user.id);

      return {
        userId: user.id,
        username: user.name,
        role: user.role,
        email: user.email,
        connectedAt: Date.now(),
      };
    } catch (error) {
      console.error("Auth failed:", error);
      throw error; // Connection will be rejected
    }
  },

  onDisconnect: async (ctx, clientId) => {
    console.log(`❌ ${ctx.username} disconnected`);
    console.log(`   Was in rooms:`, [...ctx.rooms]);

    const duration = Date.now() - ctx.connectedAt;
    console.log(`   Connected for ${duration}ms`);

    await database.sessions.end(clientId, duration);
  },
});

export default zo;
```

## Error Handling

### Connection Rejection

If `onConnect` throws, the connection is rejected:

```typescript
onConnect: async (headers) => {
  const user = await validateToken(headers.token);

  if (!user) {
    throw new Error("Invalid token"); // Connection rejected
  }

  if (user.banned) {
    throw new Error("User is banned"); // Connection rejected
  }

  return { userId: user.id };
};
```

### Header Validation

If headers don't match the schema, the connection is rejected with status 400:

```typescript
headers: z.object({
  token: z.string().min(10), // Must be at least 10 chars
});

// Client sends: { token: 'abc' }
// Result: Connection rejected with 400 Bad Request
```

## Best Practices

### 1. Validate Headers Strictly

```typescript
// ✅ Good: Strict validation
headers: z.object({
  authorization: z.string().regex(/^Bearer .+/),
  "api-key": z.string().uuid(),
});

// ❌ Bad: Too lenient
headers: z.object({
  authorization: z.string(),
});
```

### 2. Keep Context Lean

```typescript
// ✅ Good: Only essential data
onConnect: async (headers) => {
  const user = await getUser(headers.token);
  return {
    userId: user.id,
    role: user.role,
  };
};

// ❌ Bad: Too much data
onConnect: async (headers) => {
  const user = await getFullUser(headers.token);
  return user; // Entire user object
};
```

### 3. Handle Errors Gracefully

```typescript
onConnect: async (headers) => {
  try {
    const user = await validateToken(headers.token);
    return { userId: user.id };
  } catch (error) {
    console.error("Auth error:", error);
    throw new Error("Authentication failed");
  }
};
```

### 4. Log Connection Events

```typescript
onConnect: (headers, clientId) => {
  console.log(`✅ Connection: ${clientId}`);
  return { user: headers.user };
},

onDisconnect: (ctx, clientId) => {
  console.log(`❌ Disconnection: ${clientId}`);
}
```

## TypeScript Tips

The context type is inferred from `onConnect`:

```typescript
const zo = zocket.create({
  headers: z.object({ token: z.string() }),
  onConnect: async (headers) => {
    return {
      userId: "user123",
      role: "admin" as const,
    };
  },
});

// In handlers:
// ctx.userId is string
// ctx.role is 'admin'
```

## Next Steps

- [Define your router](/server/router-definition)
- [Implement handlers](/server/router-definition)
- [Start the server](/server/adapters)
